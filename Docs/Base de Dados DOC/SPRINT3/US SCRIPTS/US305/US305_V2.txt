--Main Function

create or replace function fnGetContainerRouteCursor(vClientID in CLIENT.ID%type,
                                          vContainerID in CONTAINER.CONTAINERID%type) return SYS_REFCURSOR
    is
    route_Cursor SYS_REFCURSOR;
    invalid_container exception;
    data_not_found exception;
    vCargoManifestID CONTAINERCLIENT.CARGOMANIFESTID%type;
    vVerifyIntegrity NUMBER;
    CURSOR c1
        is select CARGOMANIFESTID
           from CONTAINERCLIENT
           where CONTAINERID = vContainerID
             and CLIENTID = vClientID;

begin

    open c1;

    if (c1%notfound) then
        raise invalid_container;
    end if;

    LOOP
        FETCH c1 into
            vCargoManifestID;
        EXIT WHEN (c1%notfound);

        begin

            SELECT COUNT(*)
            INTO vVerifyIntegrity
            FROM SHIP s
            WHERE s.VEHICLEID = (SELECT F.VEHICLEID
                                 from FACILITY
                                          inner join FACILITYTRIP F on FACILITY.FACILITYID = F.FACILITYID
                                 where F.FACILITYID =
                                       (select FACILITYID
                                        from FACILITYTRIP ft
                                        where ft.IDTRIP = (Select cmf.IDTRIP
                                                           from CARGOMANIFEST cmf
                                                           where cmf.CARGOMANIFESTID = vCargoManifestID)));

            if (vVerifyIntegrity = 1) THEN

                open route_Cursor for
                    select v.Name              VEHICLE_NAME,
                           f.Name              FACILITY_NAME,
                           t.StartDate         TRIP_START_DATE,
                           t.EndDate           TRIP_END_DATE,
                           c.CARGOMANIFESTDATE CARGOMANIFEST_DATE
                    from FACILITY f
                             inner join FACILITYTRIP FT on f.FACILITYID = FT.FACILITYID,
                         SHIP v,
                         TRIP t,
                         CARGOMANIFEST c
                    where c.CARGOMANIFESTID = vCargoManifestID
                      and t.IDTRIP = (Select cmf.IDTRIP
                                      from CARGOMANIFEST cmf
                                      where cmf.CARGOMANIFESTID = vCargoManifestID)
                      and f.FACILITYID = (select FACILITYID
                                          from FACILITYTRIP ft
                                          where ft.IDTRIP = (Select cmf.IDTRIP
                                                             from CARGOMANIFEST cmf
                                                             where cmf.CARGOMANIFESTID = vCargoManifestID))
                      and v.VEHICLEID = (SELECT F.VEHICLEID
                                         from FACILITY
                                                  inner join FACILITYTRIP F on FACILITY.FACILITYID = F.FACILITYID
                                         where F.FACILITYID =
                                               (select FACILITYID
                                                from FACILITYTRIP ft
                                                where ft.IDTRIP = (Select cmf.IDTRIP
                                                                   from CARGOMANIFEST cmf
                                                                   where cmf.CARGOMANIFESTID = vCargoManifestID)));

            ELSE

                open route_Cursor for
                    select v.Name              VEHICLE_NAME,
                           f.Name              FACILITY_NAME,
                           t.StartDate         TRIP_START_DATE,
                           t.EndDate           TRIP_END_DATE,
                           c.CARGOMANIFESTDATE CARGOMANIFEST_DATE
                    from FACILITY f
                             inner join FACILITYTRIP FT on f.FACILITYID = FT.FACILITYID,
                         TRUCK v,
                         TRIP t,
                         CARGOMANIFEST c
                    where c.CARGOMANIFESTID = vCargoManifestID
                      and t.IDTRIP = (Select cmf.IDTRIP
                                      from CARGOMANIFEST cmf
                                      where cmf.CARGOMANIFESTID = vCargoManifestID)
                      and f.FACILITYID = (select FACILITYID
                                          from FACILITYTRIP ft
                                          where ft.IDTRIP = (Select cmf.IDTRIP
                                                             from CARGOMANIFEST cmf
                                                             where cmf.CARGOMANIFESTID = vCargoManifestID))
                      and v.VEHICLEID = (SELECT F.VEHICLEID
                                         from FACILITY
                                                  inner join FACILITYTRIP F on FACILITY.FACILITYID = F.FACILITYID
                                         where F.FACILITYID =
                                               (select FACILITYID
                                                from FACILITYTRIP ft
                                                where ft.IDTRIP = (Select cmf.IDTRIP
                                                                   from CARGOMANIFEST cmf
                                                                   where cmf.CARGOMANIFESTID = vCargoManifestID)));

            end if;

        end;

    end loop;

    close c1;

    return (route_Cursor);

EXCEPTION
    WHEN
        invalid_container THEN
        raise_application_error(-200001,
                                'Invalid Container or client! The is no container assigned to the specified client');
        return (null);
end;
/

--Get Vehicle Type Function (Auxiliar function)

create or replace function fnGetVehicleType(vVehicleName in varchar2)
    return varchar2 is
    vVehicleType varchar2(32);
    vNumber      number;

begin

    Select COUNT(*)
    into vNumber
    from SHIP s
    where s.NAME = vVehicleName;

    IF (vNumber = 1) THEN
        vVehicleType := 'SHIP';

    ELSE
        vVehicleType := 'TRUCK';

    end if;


    return (vVehicleType);

end;
/

-- Compile Function

ALTER FUNCTION FNGETCONTAINERROUTECURSOR compile;

-- Drop Function

DROP FUNCTION FNGETCONTAINERROUTECURSOR;

-- Test the  main function

declare
	result SYS_REFCURSOR;
	VCLIENTID CLIENT.ID %TYPE := 1;
	VCONTAINERID CONTAINER.CONTAINERID %TYPE := 2579;
begin
	result := FNGETCONTAINERROUTECURSOR(
		VCLIENTID => VCLIENTID,
		VCONTAINERID => VCONTAINERID
	);
end;


